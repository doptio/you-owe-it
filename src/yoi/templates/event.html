<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      id='journal-page'>
<xi:include href='page.html'/>
<head/>
<body>
  <div id='content'>
    <h1>${event.name}</h1>

    <?python
      dict = type({})
      people = dict((person.person_id, person)
                    for person in event.members)
      is_member = (g.user and
                   g.user.id in [member.user_id for member in event.members])
    ?>

    <ul class='button-group radius' py:if='is_member'>
      <li><a class='large button for-dialog'
             data-dialog='add-people' href='#'>Add people</a></li>
      <li><a class='large button'
             href='${url_for("new_entry",
                             external_id=event.external_id,
                             slug=event.slug)}'>Add entry</a></li>
      <li><a class='large button for-dialog'
             data-dialog='invite-friends' href='#'>Invite friends</a></li>
    </ul>
    <ul class='button-group radius' py:if='not is_member'>
      <li py:if='g.user'>
        <a class='large button for-dialog'
           data-dialog='join' href='#'>Join!</a>
      </li>
      <li py:if='not g.user'>
        <a href='${url_for("account.login", r=request.path + "#join")}'
           class='large button'>Join!</a>
      </li>
    </ul>

    <div class='panel radius'>
      <h2>members</h2>
      <ul id='overview' class='block-grid three-up'>
        <li py:for='person in event.members'>
          ${render_avatar_img(person)}
          ${person.name}<br/>
          ${render_amount(event.person_total[person.person_id])}
        </li>
      </ul>
    </div>

    <h2>latest entries</h2>
    <p py:if='not event.all_entries'>
      This event has no entries yet,
      <a href='${url_for("new_entry",
                         external_id=event.external_id,
                         slug=event.slug)}'>add one</a>?
    </p>
    <table py:if='event.all_entries'>
      <thead>
        <th id='date'>date</th>
        <th id='amount' class='number'>amount</th>
        <th>who</th>
        <th>description</th>
      </thead>

      <tbody py:for='entry in event.all_entries[:3]'
             py:with='total_shares = sum(v.share for v in entry.victims)'>
        <tr>
          <td>${entry.date.strftime('%Y-%m-%d')}</td>
          <td class='number'>${render_amount(entry.amount)}</td>
          <td>${people[entry.payer].name}</td>
          <td>${entry.description}</td>
        </tr>
        <tr py:for='victim in entry.victims'>
          <td/>
          <td class='number'>${render_amount(- entry.amount
                                               * victim.share
                                               / total_shares)}</td>
          <td>${people[victim.victim].name}</td>
          <td/>
        </tr>
      </tbody>
    </table>
    <a class='nice large radius button' href='#'>View all entries</a>

    <div id='add-people' class='dialog'>
      <h1>Add People</h1>
      <p>Enter the names of people to add, one per input:</p>
      <ol class='input-fix'>
        <li><input type='text' name='name' placeholder='name'/></li>
      </ol>
    </div>

    <div id='invite-friends' class='dialog'>
      <h1>Invite Friends</h1>
      <p>Invite your friends to join this journal via this link:</p>
      <div style='padding: .5em 2em;'>
        <a href='${request.base_url}'>${request.base_url}</a>
      </div>
    </div>

    <div id='join' class='dialog'>
      <h1>Select yourself</h1>
      <ul class='block-grid three-up'>
        <li py:for='person in event.members' py:if='not person.user_id'>
          <a href='#'>${render_avatar(person)}</a>
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
