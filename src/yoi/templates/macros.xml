<xml xmlns:py="http://genshi.edgewall.org/" py:strip=''>

<?python
  from hashlib import md5

  def avatar_url(email, size=60):
    hash = md5((email or '').lower()).hexdigest()
    return 'http://www.gravatar.com/avatar/{}?size={}'.format(hash, size)
?>

<py:def function='render_avatar_img(person, size=60)'>
  <img src='${avatar_url(person.email, size=size)}'
       class='avatar-img' width='${size}' height='${size}'
       alt="${person.name}'s avatar"/>
</py:def>

<py:def function='render_avatar(person, size=60)'>
  <span class='avatar' data-person='${person.person_id}'>
    ${render_avatar_img(person, size=size)}<br/>
    ${person.name}
  </span>
</py:def>

<py:def function='render_amount(amount)'>
  <span py:if='amount &lt; 0' class='red'>
    &minus; ${'%.1f' % (-amount / 100.0)}
  </span>
  <span py:if='amount >= 0' class='green'>
    + ${'%.1f' % (amount / 100.0)}
  </span>
</py:def>

<py:def function='render_field(field, **kwargs)'>
  <ul py:if='field.errors' class='errors'>
    <li py:for='error in field.errors'>${error}</li>
  </ul>
  ${field(**kwargs)}
</py:def>

<py:def function='render_entries(entries)'>
  <?python
    dict = type({})
    people = dict((person.person_id, person)
                  for person in event.members)
  ?>
  <table class='entries'>
    <thead>
      <th id='date'>date</th>
      <th id='amount' class='number'>amount</th>
      <th>who</th>
      <th>description</th>
    </thead>

    <tbody py:for='entry in entries'
           py:with='total_shares = sum(v.share for v in entry.victims)'>
      <tr>
        <td>${entry.date.strftime('%Y-%m-%d')}</td>
        <td class='number'>${render_amount(entry.amount)}</td>
        <td>${people[entry.payer].name}</td>
        <td>${entry.description}</td>
      </tr>
      <tr py:for='victim in entry.victims'>
        <td/>
        <td class='number'>${render_amount(- entry.amount
                                             * victim.share
                                             / total_shares)}</td>
        <td>${people[victim.victim].name}</td>
        <td/>
      </tr>
    </tbody>
  </table>
</py:def>

</xml>
